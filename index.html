<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Easy Delivery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Kanit:400,700&display=swap" rel="stylesheet">
  <style>
    body { background: #F7FAFC; font-family: 'Kanit', 'Inter', sans-serif; }
    .primary-gradient { background: linear-gradient(90deg, #FF5722 0%, #FFC107 100%); }
    .accent-btn { background: #FF5722; color: #fff; border-radius: 9999px; box-shadow: 0 4px 16px -6px #FF9800; font-weight: bold; font-size: 1.1em;}
    .category-active { background: linear-gradient(90deg, #FF5722 0%, #FFC107 100%); color: white; box-shadow: 0 6px 12px -4px rgba(220, 38, 38, 0.12);}
    .food-card { transition: all 0.3s ease; }
    .food-card:hover { transform: translateY(-5px) scale(1.04); box-shadow: 0 10px 30px -3px rgba(255,87,34,0.14);}
    .accent-price { color: #FFC107; font-weight: bold; font-size: 1.1em; }
    .cart-item-animation { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px);} to { opacity:1; transform:translateX(0);}}
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none;}
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .modal-overlay { background: rgba(0,0,0,0.5); position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    .option-button { transition: all 0.2s ease;}
    .option-button.selected { background:#FF5722; color:white; border-color:#FF5722;}
    .tab-active { color: #FF5722; border-bottom: 2px solid #FF5722; font-weight: bold;}
    .tab-inactive { color: #6b7280;}
    .fav-heart { transition: color 0.2s;}
    .fav-heart.active { color: #FF5722;}
    .order-status { font-size: 0.95em; }
    .order-status.waiting { color: #f59e42;}
    .order-status.preparing { color: #2563eb;}
    .order-status.delivering { color: #eab308;}
    .order-status.completed { color: #22c55e;}
    .order-status.canceled { color: #dc2626;}
    .glow { text-shadow: 0 0 8px #FFC107, 0 0 2px #fff; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const DELIVERY_FEE = 50;
const COLORS = { primary: "#FF5722", accent: "#FFC107", secondary: "#009688" };
const foodOptions = {
  spiciness: [
    { id: "mild", name: "‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢", price: 0 },
    { id: "medium", name: "‡πÄ‡∏ú‡πá‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", price: 0 },
    { id: "hot", name: "‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å", price: 0 }
  ],
  size: [
    { id: "normal", name: "‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤", price: 0 },
    { id: "special", name: "‡∏û‡∏¥‡πÄ‡∏®‡∏©", price: 10 }
  ],
  noodleType: [
    { id: "senlek", name: "‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å", price: 0 },
    { id: "senyai", name: "‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà", price: 0 },
    { id: "baamee", name: "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà", price: 0 },
    { id: "woon", name: "‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô", price: 0 }
  ]
};
const drinkOptions = {
  sweetness: [
    { id: "normal", name: "‡∏õ‡∏Å‡∏ï‡∏¥", price: 0 },
    { id: "less", name: "‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ (50%)", price: 0 },
    { id: "little", name: "‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (25%)", price: 0 },
    { id: "none", name: "‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏≤‡∏ô (0%)", price: 0 }
  ],
  ice: [
    { id: "normal", name: "‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏õ‡∏Å‡∏ï‡∏¥", price: 0 },
    { id: "less", name: "‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ô‡πâ‡∏≠‡∏¢", price: 0 },
    { id: "none", name: "‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á", price: 0 }
  ]
};
const categories = [
  { id: "all", name: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", icon: "üçî" },
  { id: "food", name: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", icon: "üç≤" },
  { id: "drink", name: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", icon: "ü•§" },
  { id: "snack", name: "‡∏Ç‡∏ô‡∏°", icon: "üç©" },
  { id: "dessert", name: "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô", icon: "üç∞" },
  { id: "convenience", name: "‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠", icon: "üè™" }
];
const restaurants = [
  { id: 1, name: "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏≠‡∏£‡πà‡∏≠‡∏¢" },
  { id: 2, name: "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô" },
  { id: 3, name: "‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡∏ü‡∏¥‡∏ô‡πÜ" },
  { id: 4, name: "7-11", parent: "convenience" },
  { id: 5, name: "CJ More", parent: "convenience" },
  { id: 6, name: "Lotus Express", parent: "convenience" },
  { id: 7, name: "‡πÑ‡∏ó‡∏ü‡∏π‡πâ‡∏î", parent: "convenience" }
];
const foodItems = [
  // ‡πÄ‡∏°‡∏ô‡∏π‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  { id: 1, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà", price: 50, category: "food", description: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î‡πÑ‡∏î‡πâ", image: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà.jpg", rating: 4.8, restaurantId: 1, options: ["spiciness", "size"] },
  { id: 2, name: "‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢", price: 60, category: "food", description: "‡πÉ‡∏™‡πà‡∏ñ‡∏±‡πà‡∏ß‡∏á‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏£‡∏µ", image: "‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢.jpg", rating: 4.7, restaurantId: 1, options: ["spiciness", "size"] },
  { id: 3, name: "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠", price: 45, category: "food", description: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏î‡πâ", image: "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠.jpg", rating: 4.5, restaurantId: 1, options: ["spiciness", "noodleType"] },
  { id: 4, name: "‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°‡∏™‡∏î", price: 40, category: "drink", description: "‡∏Ñ‡∏±‡πâ‡∏ô‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô", image: "‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°‡∏™‡∏î.jpg", rating: 4.6, restaurantId: 2, options: ["sweetness", "ice"] },
  { id: 5, name: "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", price: 35, category: "drink", description: "‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ ‡∏´‡∏≠‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", image: "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß.jpg", rating: 4.4, restaurantId: 2, options: ["sweetness", "ice"] },
  { id: 6, name: "‡πÇ‡∏î‡∏ô‡∏±‡∏ó", price: 30, category: "snack", description: "‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", image: "‡πÇ‡∏î‡∏ô‡∏±‡∏ó.jpg", rating: 4.3, restaurantId: 3, options: [] },
  { id: 7, name: "‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï", price: 65, category: "dessert", description: "‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏î‡∏≤‡∏£‡πå‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï", image: "‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï.jpg", rating: 4.9, restaurantId: 3, options: [] },
  { id: 8, name: "‡∏ã‡∏π‡∏ä‡∏¥", price: 120, category: "food", description: "‡πÄ‡∏ã‡πá‡∏ï‡∏ú‡∏™‡∏° 8 ‡∏ä‡∏¥‡πâ‡∏ô", image: "‡∏ã‡∏π‡∏ä‡∏¥.jpg", rating: 4.7, restaurantId: 1, options: [] },
  // ‡πÄ‡∏°‡∏ô‡∏π‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠ (15 ‡πÄ‡∏°‡∏ô‡∏π)
  { id: 9, name: "‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤ (7-11)", price: 10, category: "convenience", description: "‡∏Ç‡∏ß‡∏î 600ml", image: "‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤ (7-11).jpg", rating: 4.9, restaurantId: 4, options: [] },
  { id: 10, name: "‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ó (CJ More)", price: 29, category: "convenience", description: "‡πÑ‡∏™‡πâ‡πÅ‡∏Æ‡∏°‡∏ä‡∏µ‡∏™", image: "‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ó (CJ More).jpg", rating: 4.7, restaurantId: 5, options: [] },
  { id: 11, name: "‡πÇ‡∏Ñ‡πâ‡∏Å‡∏Ç‡∏ß‡∏î 500ml (Lotus Express)", price: 20, category: "convenience", description: "‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°‡∏Ç‡∏ß‡∏î", image: "‡πÇ‡∏Ñ‡πâ‡∏Å‡∏Ç‡∏ß‡∏î 500ml (Lotus Express).jpg", rating: 4.5, restaurantId: 6, options: [] },
  { id: 12, name: "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÑ‡∏ó‡∏ü‡∏π‡πâ‡∏î", price: 25, category: "convenience", description: "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏ô‡∏∏‡πà‡∏°", image: "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÑ‡∏ó‡∏ü‡∏π‡πâ‡∏î.jpg", rating: 4.8, restaurantId: 7, options: [] },
  { id: 13, name: "‡∏¢‡∏≥‡πÅ‡∏ã‡πà‡∏ö 7-11", price: 42, category: "convenience", description: "‡∏£‡∏™‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏ô", image: "‡∏¢‡∏≥‡πÅ‡∏ã‡πà‡∏ö 7-11.jpg", rating: 4.6, restaurantId: 4, options: [] },
  { id: 14, name: "‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡∏°‡πâ‡∏ß‡∏ô CJ", price: 37, category: "convenience", description: "‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", image: "‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡∏°‡πâ‡∏ß‡∏ô CJ.jpg", rating: 4.6, restaurantId: 5, options: [] },
  { id: 15, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á Lotus Express", price: 45, category: "convenience", description: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", image: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á Lotus Express.jpg", rating: 4.7, restaurantId: 6, options: [] },
  { id: 16, name: "‡∏ô‡∏°‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡πÑ‡∏ó‡∏ü‡∏π‡πâ‡∏î", price: 15, category: "convenience", description: "‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", image: "‡∏ô‡∏°‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡πÑ‡∏ó‡∏ü‡∏π‡πâ‡∏î.jpg", rating: 4.8, restaurantId: 7, options: [] },
  { id: 17, name: "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏•‡∏µ‡πÇ‡∏≠ 7-11", price: 55, category: "convenience", description: "‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå (‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏õ‡∏µ)", image: "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏•‡∏µ‡πÇ‡∏≠ 7-11.jpg", rating: 4.9, restaurantId: 4, options: [] },
  { id: 18, name: "‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ CJ", price: 25, category: "convenience", description: "‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á", image: "‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ CJ.jpg", rating: 4.5, restaurantId: 5, options: [] },
  { id: 19, name: "‡∏Ç‡∏ô‡∏°‡∏Ç‡∏≤‡πÑ‡∏Å‡πà Lotus Express", price: 10, category: "convenience", description: "‡∏Ç‡∏ô‡∏°‡∏Å‡∏£‡∏∏‡∏ö‡∏Å‡∏£‡∏≠‡∏ö", image: "‡∏Ç‡∏ô‡∏°‡∏Ç‡∏≤‡πÑ‡∏Å‡πà Lotus Express.jpg", rating: 4.4, restaurantId: 6, options: [] },
  { id: 20, name: "‡∏ñ‡∏∏‡∏á‡∏Ç‡∏¢‡∏∞ ‡πÑ‡∏ó‡∏ü‡∏π‡πâ‡∏î", price: 20, category: "convenience", description: "‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", image: "‡∏ñ‡∏∏‡∏á‡∏Ç‡∏¢‡∏∞ ‡πÑ‡∏ó‡∏ü‡∏π‡πâ‡∏î.jpg", rating: 4.7, restaurantId: 7, options: [] },
  { id: 21, name: "‡∏ô‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á UHT 7-11", price: 13, category: "convenience", description: "‡∏ô‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å", image: "‡∏ô‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á UHT 7-11.jpg", rating: 4.8, restaurantId: 4, options: [] },
  { id: 22, name: "‡πÄ‡∏ã‡∏£‡∏±‡πà‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ú‡∏¥‡∏ß CJ", price: 99, category: "convenience", description: "‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", image: "‡πÄ‡∏ã‡∏£‡∏±‡πà‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ú‡∏¥‡∏ß CJ.jpg", rating: 4.7, restaurantId: 5, options: [] },
  { id: 23, name: "‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå Lotus Express", price: 25, category: "convenience", description: "‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", image: "‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå Lotus Express.jpg", rating: 4.6, restaurantId: 6, options: [] }
];

const initialReviews = [
  { foodId: 1, user: "‡∏™‡∏°‡∏ä‡∏≤‡∏¢", rating: 5, comment: "‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡∏™‡πà‡∏á‡πÑ‡∏ß", createdAt: new Date(Date.now() - 86400000) },
  { foodId: 1, user: "‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏£", rating: 4, comment: "‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏î‡∏µ‡∏Ñ‡πà‡∏∞", createdAt: new Date(Date.now() - 55000000) },
  { foodId: 3, user: "Bank", rating: 5, comment: "‡∏ô‡πâ‡∏≥‡∏ã‡∏∏‡∏õ‡πÄ‡∏î‡πá‡∏î‡∏à‡∏£‡∏¥‡∏á", createdAt: new Date(Date.now() - 3600000) }
];
const demoUser = {
  name: "Guest", phone: "", address: "", favorites: [], orderHistory: []
};
const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);

function loadUserFromStorage() {
  try {
    const data = JSON.parse(localStorage.getItem('userProfile'));
    if (data) return data;
  } catch (e) {}
  return demoUser;
}
function saveUserToStorage(user) {
  localStorage.setItem('userProfile', JSON.stringify(user));
}
function loadOrderHistoryFromStorage(phone) {
  try {
    const orders = JSON.parse(localStorage.getItem("orders")) || [];
    return orders.filter(o => o.userInfo?.phone === phone);
  } catch (e) { return []; }
}
async function sendOrderToMake(order) {
  await fetch('https://hook.eu2.make.com/akm7obib5cpwws5dtfve8waqlp26rj9v', { // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(order)
  });
}

// --- Header ---
function Header({ cartCount, onCartClick, onProfileClick, onBack, showBack }) {
  return (
    <header className="bg-white shadow-sm py-4 px-5 sticky top-0 z-30">
      <div className="flex items-center justify-between">
        {showBack ? (
          <button onClick={onBack} className="text-gray-700">
            <i className="fas fa-chevron-left"></i>
          </button>
        ) : (<div className="w-6"></div>)}
        <h1 className="text-2xl font-bold text-orange-500 tracking-tight flex items-center gap-2">
          <span className="text-orange-500 text-3xl"><i className="fas fa-utensils"></i></span> Easy Delivery
        </h1>
        <div className="flex items-center gap-3">
          <button onClick={onProfileClick} className="text-gray-700" title="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">
            <i className="fas fa-user-circle text-2xl"></i>
          </button>
          <div className="relative">
            <button onClick={onCartClick} className="text-gray-700 relative" title="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤">
              <i className="fas fa-shopping-cart text-2xl"></i>
              {cartCount > 0 && (
                <span className="absolute -top-2 -right-2 bg-orange-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">
                  {cartCount}
                </span>
              )}
            </button>
          </div>
        </div>
      </div>
    </header>
  );
}

// --- BannerPromo ---
function BannerPromo() {
  return (
    <div className="mt-6 px-5">
      <div className="primary-gradient rounded-2xl shadow-xl p-6 flex flex-col justify-center items-center relative overflow-hidden">
        <h2 className="text-white text-2xl font-bold drop-shadow-lg mb-1 text-center">
          ‡∏™‡∏±‡πà‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡πà‡∏á‡πÑ‡∏ß ‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô
          <br/>
          <span className="block text-xl font-bold mt-2 text-yellow-300 glow">‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á  40 ‡∏ö‡∏≤‡∏ó</span>
        </h2>
        <div className="text-white text-sm font-medium mt-2 text-center">
          ‡∏´‡∏¥‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Å‡πá‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π!
        </div>
        <button className="accent-btn px-8 py-3 mt-4 text-lg">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢</button>
      </div>
    </div>
  );
}

// --- TabBar ---
function TabBar({ tabs, active, setActive }) {
  return (
    <div className="flex border-b bg-white sticky top-[60px] z-20">
      {tabs.map(t => (
        <button
          key={t.id}
          className={`flex-1 py-3 px-2 text-center text-base transition ${active === t.id ? "tab-active" : "tab-inactive"}`}
          onClick={() => setActive(t.id)}
        >
          <span className="text-xl mr-1">{t.icon}</span><span className="font-bold">{t.name}</span>
        </button>
      ))}
    </div>
  );
}

// --- SearchBar ---
function SearchBar({ searchQuery, setSearchQuery, filter, setFilter, enableAdvanced }) {
  return (
    <div className="px-5 mt-4">
      <div className="bg-white rounded-xl shadow-sm p-3 flex items-center">
        <i className="fas fa-search text-orange-400 ml-1 mr-3"></i>
        <input
          type="text"
          placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤..."
          className="w-full outline-none text-gray-700 placeholder-gray-400 bg-transparent"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
        />
        {searchQuery && (
          <button onClick={() => setSearchQuery("")} className="text-gray-400 ml-2">
            <i className="fas fa-times"></i>
          </button>
        )}
        {enableAdvanced && (
          <button onClick={() => setFilter(f => ({ ...f, show: !f.show }))}
            className="ml-3 text-gray-500 hover:text-orange-500" title="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á"
          >
            <i className="fas fa-filter"></i>
          </button>
        )}
      </div>
      {enableAdvanced && filter.show && (
        <div className="bg-white rounded-xl shadow-md mt-2 p-3 space-y-3">
          <div className="flex gap-3 flex-wrap">
            <select value={filter.restaurant} onChange={e => setFilter(f => ({ ...f, restaurant: e.target.value }))}
              className="border rounded px-2 py-1 text-sm">
              <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option>
              {restaurants.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
            </select>
            <select value={filter.sort} onChange={e => setFilter(f => ({ ...f, sort: e.target.value }))}
              className="border rounded px-2 py-1 text-sm">
              <option value="default">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°</option>
              <option value="price-asc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥-‡∏™‡∏π‡∏á</option>
              <option value="price-desc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á-‡∏ï‡πà‡∏≥</option>
              <option value="rating-desc">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</option>
            </select>
          </div>
        </div>
      )}
    </div>
  );
}

// --- CategoryList ---
function CategoryList({ selectedCategory, onSelectCategory }) {
  return (
    <div className="mt-6 px-5">
      <div className="flex space-x-3 overflow-x-auto pb-2 hide-scrollbar">
        {categories.map(category => (
          <button
            key={category.id}
            onClick={() => onSelectCategory(category.id)}
            className={`flex flex-col items-center py-2 px-4 rounded-2xl min-w-max transition category-btn
              ${selectedCategory === category.id ? 'category-active' : 'bg-white text-gray-700 shadow-sm'}`}
          >
            <span className="text-2xl mb-1">{category.icon}</span>
            <span className="text-xs font-semibold">{category.name}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

// --- FoodList ---
function FoodList({ foods, onAddToCart, searchQuery, favorites, onToggleFavorite, onShowReviews, reviews }) {
  return (
    <div className="mt-6 px-5 mb-24">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-gray-900">
          {searchQuery ? `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${searchQuery}"` : "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"}
        </h2>
        <span className="text-sm text-gray-500">{foods.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>
      {foods.length === 0 ? (
        <div className="text-center py-10">
          <i className="fas fa-search text-gray-300 text-5xl mb-3"></i>
          <p className="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
          <p className="text-sm text-gray-400 mt-1">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡∏î‡∏π‡∏ô‡∏∞</p>
        </div>
      ) : (
        <div className="grid grid-cols-2 gap-5">
          {foods.map(food => {
            const restaurant = restaurants.find(r => r.id === food.restaurantId);
            const fav = favorites.includes(food.id);
            const foodReviews = reviews.filter(r => r.foodId === food.id);
            return (
              <div key={food.id} className="food-card bg-white rounded-2xl shadow-xl overflow-hidden">
                <div className="relative">
                  <img src={food.image} alt={food.name} className="w-full h-32 object-cover" />
                  <button onClick={() => onToggleFavorite(food.id)}
                    className={`absolute top-2 right-2 fav-heart ${fav ? "active" : ""}`}
                    title={fav ? "‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î"}
                  >
                    <i className="fas fa-heart text-xl"></i>
                  </button>
                </div>
                <div className="p-4">
                  <h3 className="font-bold text-gray-900 text-base">{food.name}</h3>
                  <p className="text-xs text-gray-500 mt-1">{restaurant?.name}</p>
                  <div className="flex justify-between items-center mt-3">
                    <span className="accent-price">{formatCurrency(food.price)}</span>
                    <button
                      onClick={() => onAddToCart(food)}
                      className="accent-btn w-9 h-9 flex items-center justify-center hover:bg-orange-600 transition"
                    >
                      <i className="fas fa-plus text-base"></i>
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// --- FoodReviewModal ---
function FoodReviewModal({ food, reviews, onClose, onAddReview, user }) {
  const [newReview, setNewReview] = React.useState({ rating: 5, comment: "" });
  const [showForm, setShowForm] = React.useState(false);
  return (
    <div className="modal-overlay">
      <div className="bg-white rounded-2xl w-full max-w-md modal-content">
        <div className="p-5">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-900">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß {food.name}</h2>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
              <i className="fas fa-times text-xl"></i>
            </button>
          </div>
          <div className="mb-4">
            <img src={food.image} alt={food.name} className="w-24 h-24 object-cover rounded-xl mx-auto" />
          </div>
          <div className="mb-4">
            {reviews.length === 0 ? (
              <div className="text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
            ) : (
              <div className="space-y-3 max-h-40 overflow-y-auto">
                {reviews.map((r, i) => (
                  <div key={i} className="bg-gray-100 rounded-lg px-3 py-2">
                    <div>
                      <span className="text-yellow-400">
                        {"‚òÖ".repeat(r.rating)}{"‚òÜ".repeat(5 - r.rating)}
                      </span>
                      <span className="ml-2 text-gray-800 text-sm font-bold">{r.user}</span>
                      <span className="ml-2 text-xs text-gray-500">{new Date(r.createdAt).toLocaleString("th-TH")}</span>
                    </div>
                    <div className="text-gray-700 text-sm mt-1">{r.comment}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
          <button className="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-bold mb-2"
            onClick={() => setShowForm(s => !s)}>
            {showForm ? "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"}
          </button>
          {showForm && (
            <form onSubmit={e => { e.preventDefault(); onAddReview(newReview); setShowForm(false);}}
              className="bg-gray-50 p-3 rounded-lg mt-2">
              <div>
                <span className="mr-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span>
                {[1,2,3,4,5].map(n =>
                  <button key={n} type="button"
                    onClick={() => setNewReview(r => ({ ...r, rating: n }))}
                    className={n <= newReview.rating ? "text-yellow-500" : "text-gray-400"}>
                    <i className="fas fa-star"></i>
                  </button>
                )}
              </div>
              <textarea required placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." className="w-full mt-2 p-2 border rounded"
                value={newReview.comment} onChange={e => setNewReview(r => ({...r, comment:e.target.value}))}/>
              <button type="submit" className="w-full mt-2 bg-red-500 text-white py-2 rounded font-bold">
                ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
              </button>
            </form>
          )}
        </div>
      </div>
    </div>
  );
}

// --- ItemOptionsModal ---
function ItemOptionsModal({ item, isOpen, onClose, onAddToCartWithOptions }) {
  const [selectedOptions, setSelectedOptions] = React.useState({});
  const [quantity, setQuantity] = React.useState(1);
  React.useEffect(() => {
    const defaultOptions = {};
    if (item.options.includes('spiciness')) defaultOptions.spiciness = foodOptions.spiciness[1];
    if (item.options.includes('size')) defaultOptions.size = foodOptions.size[0];
    if (item.options.includes('sweetness')) defaultOptions.sweetness = drinkOptions.sweetness[0];
    if (item.options.includes('ice')) defaultOptions.ice = drinkOptions.ice[0];
    if (item.options.includes('noodleType')) defaultOptions.noodleType = foodOptions.noodleType[0];
    setSelectedOptions(defaultOptions); setQuantity(1);
  }, [item]);
  if (!isOpen) return null;
  const restaurant = restaurants.find(r => r.id === item.restaurantId);

  const handleOptionSelect = (optionType, option) => {
    setSelectedOptions(prev => ({ ...prev, [optionType]: option }));
  };
  const calculateTotalPrice = () => {
    let total = item.price;
    Object.values(selectedOptions).forEach(option => { total += option.price; });
    return total * quantity;
  };
  const handleAddToCart = () => {
    onAddToCartWithOptions(item, selectedOptions, quantity);
    onClose();
  };

  return (
    <div className="modal-overlay">
      <div className="bg-white rounded-2xl w-full max-w-md modal-content">
        <div className="p-5">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h2>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
              <i className="fas fa-times text-xl"></i>
            </button>
          </div>
          <div className="flex items-start mb-4">
            <img src={item.image} alt={item.name} className="w-20 h-20 object-cover rounded-xl" />
            <div className="ml-4">
              <h3 className="font-bold text-gray-900">{item.name}</h3>
              <p className="text-sm text-gray-500">{restaurant?.name}</p>
              <p className="text-red-600 font-bold mt-1">{formatCurrency(item.price)}</p>
            </div>
          </div>
          <div className="mb-6">
            <h4 className="font-medium text-gray-900 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h4>
            <div className="flex items-center">
              <button onClick={() => setQuantity(Math.max(1, quantity - 1))}
                className="w-10 h-10 rounded-lg border border-gray-300 flex items-center justify-center">
                <i className="fas fa-minus"></i>
              </button>
              <span className="mx-4 font-bold text-lg">{quantity}</span>
              <button onClick={() => setQuantity(quantity + 1)}
                className="w-10 h-10 rounded-lg border border-gray-300 flex items-center justify-center">
                <i className="fas fa-plus"></i>
              </button>
            </div>
          </div>
          {item.options.includes('spiciness') && (
            <div className="mb-6">
              <h4 className="font-medium text-gray-900 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î</h4>
              <div className="grid grid-cols-3 gap-2">
                {foodOptions.spiciness.map(option => (
                  <button key={option.id}
                    onClick={() => handleOptionSelect('spiciness', option)}
                    className={`option-button py-2 px-3 rounded-lg border ${selectedOptions.spiciness?.id === option.id ? 'selected' : 'border-gray-300'}`}>
                    {option.name}
                  </button>
                ))}
              </div>
            </div>
          )}
          {item.options.includes('size') && (
            <div className="mb-6">
              <h4 className="font-medium text-gray-900 mb-2">‡∏Ç‡∏ô‡∏≤‡∏î</h4>
              <div className="grid grid-cols-2 gap-2">
                {foodOptions.size.map(option => (
                  <button key={option.id}
                    onClick={() => handleOptionSelect('size', option)}
                    className={`option-button py-2 px-3 rounded-lg border ${selectedOptions.size?.id === option.id ? 'selected' : 'border-gray-300'}`}>
                    {option.name}
                    {option.price > 0 && ` (+${formatCurrency(option.price)})`}
                  </button>
                ))}
              </div>
            </div>
          )}
          {item.options.includes('noodleType') && (
            <div className="mb-6">
              <h4 className="font-medium text-gray-900 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô</h4>
              <div className="grid grid-cols-2 gap-2">
                {foodOptions.noodleType.map(option => (
                  <button key={option.id}
                    onClick={() => handleOptionSelect('noodleType', option)}
                    className={`option-button py-2 px-3 rounded-lg border ${selectedOptions.noodleType?.id === option.id ? 'selected' : 'border-gray-300'}`}>
                    {option.name}
                  </button>
                ))}
              </div>
            </div>
          )}
          {item.options.includes('sweetness') && (
            <div className="mb-6">
              <h4 className="font-medium text-gray-900 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô</h4>
              <div className="grid grid-cols-2 gap-2">
                {drinkOptions.sweetness.map(option => (
                  <button key={option.id}
                    onClick={() => handleOptionSelect('sweetness', option)}
                    className={`option-button py-2 px-3 rounded-lg border ${selectedOptions.sweetness?.id === option.id ? 'selected' : 'border-gray-300'}`}>
                    {option.name}
                  </button>
                ))}
              </div>
            </div>
          )}
          {item.options.includes('ice') && (
            <div className="mb-6">
              <h4 className="font-medium text-gray-900 mb-2">‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</h4>
              <div className="grid grid-cols-3 gap-2">
                {drinkOptions.ice.map(option => (
                  <button key={option.id}
                    onClick={() => handleOptionSelect('ice', option)}
                    className={`option-button py-2 px-3 rounded-lg border ${selectedOptions.ice?.id === option.id ? 'selected' : 'border-gray-300'}`}>
                    {option.name}
                  </button>
                ))}
              </div>
            </div>
          )}
          <div className="border-t pt-4 mt-4">
            <div className="flex justify-between items-center mb-4">
              <span className="font-bold text-gray-900">‡∏£‡∏ß‡∏°</span>
              <span className="font-bold text-red-600 text-lg">{formatCurrency(calculateTotalPrice())}</span>
            </div>
            <button onClick={handleAddToCart}
              className="w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition-colors">
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// --- CartItem ---
function CartItem({ item, onUpdateQty, onRemove }) {
  const restaurant = restaurants.find(r => r.id === item.restaurantId);
  return (
    <div className="cart-item-animation bg-white rounded-xl p-4 shadow-sm mb-3">
      <div className="flex justify-between items-start">
        <div className="flex-1">
          <h3 className="font-medium text-gray-900">{item.name}</h3>
          <p className="text-xs text-gray-500">{restaurant?.name}</p>
          {item.selectedOptions && Object.keys(item.selectedOptions).length > 0 && (
            <div className="mt-2 text-xs text-gray-600">
              {Object.entries(item.selectedOptions).map(([key, option]) => (
                <div key={key}>{option?.name}</div>
              ))}
            </div>
          )}
          <p className="text-red-600 font-bold mt-1">{formatCurrency(item.price)}</p>
        </div>
        <button onClick={() => onRemove(item)} className="text-gray-400">
          <i className="fas fa-times"></i>
        </button>
      </div>
      <div className="flex items-center justify-between mt-3">
        <div className="flex items-center space-x-3">
          <button
            onClick={() => onUpdateQty(item, item.qty - 1)}
            className="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center"
          >
            <i className="fas fa-minus text-gray-600 text-xs"></i>
          </button>
          <span className="font-bold">{item.qty}</span>
          <button
            onClick={() => onUpdateQty(item, item.qty + 1)}
            className="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center"
          >
            <i className="fas fa-plus text-gray-600 text-xs"></i>
          </button>
        </div>
        <span className="font-bold text-gray-900">{formatCurrency(item.price * item.qty)}</span>
      </div>
    </div>
  );
}

// --- CartPage ---
function CartPage({ cart, onUpdateQty, onRemoveItem, onBack, onCheckout, onPay, totalAmount }) {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
// const deliveryFee = DELIVERY_FEE; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ
const total = subtotal; // ‡πÑ‡∏°‡πà‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
  return (
    <div className="min-h-screen bg-gray-50 pb-24">
      <Header
        cartCount={cart.reduce((sum, item) => sum + item.qty, 0)}
        onBack={onBack}
        showBack={true}
      />
      <div className="px-5 pt-4">
        <h2 className="text-xl font-bold text-gray-900 mb-6">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        {cart.length === 0 ? (
          <div className="text-center py-10">
            <i className="fas fa-shopping-cart text-gray-300 text-5xl mb-4"></i>
            <p className="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
            <button
              onClick={onBack}
              className="mt-4 text-red-600 font-medium"
            >
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏¢
            </button>
          </div>
        ) : (
          <>
            <div className="mb-4">
              {cart.map((item, idx) => (
                <CartItem
                  key={item.id + JSON.stringify(item.selectedOptions || {})}
                  item={item}
                  onUpdateQty={onUpdateQty}
                  onRemove={onRemoveItem}
                />
              ))}
            </div>
            <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
              <div className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                  <span className="font-medium">{formatCurrency(subtotal)}</span>
                </div>
                <div className="flex justify-center">
  <div className="bg-gradient-to-r from-orange-100 via-yellow-50 to-white border-l-4 border-orange-400 rounded-xl p-4 w-full my-2 shadow flex flex-col items-center">
    <div className="flex items-center gap-2 mb-2">
      <i className="fas fa-motorcycle text-orange-500 text-lg"></i>
      <span className="font-bold text-orange-700 text-base">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</span>
    </div>
    <div className="w-full max-w-xs text-gray-800 text-sm font-medium text-center">
      <div className="py-1">0-3 ‡∏Å‡∏°. <span className="text-orange-600 font-bold">40 ‡∏ö‡∏≤‡∏ó</span></div>
      <div className="py-1">3-6 ‡∏Å‡∏°. <span className="text-orange-600 font-bold">60 ‡∏ö‡∏≤‡∏ó</span></div>
      <div className="py-1">6-10 ‡∏Å‡∏°. <span className="text-orange-600 font-bold">80 ‡∏ö‡∏≤‡∏ó</span></div>
    </div>
    <div className="mt-2 text-xs text-gray-500 italic text-center">
      *‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö location ‡∏ó‡∏≤‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß
    </div>
  </div>
</div>
                <div className="border-t pt-3 flex justify-between font-bold text-lg">
                  <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                  <span className="text-red-600">{formatCurrency(total)}</span>
                </div>
              </div>
            </div>
            <div className="flex space-x-3">
              <button
                onClick={onPay}
                className="flex-1 bg-red-500 text-white py-4 rounded-xl font-bold text-lg shadow-md hover:bg-red-600 transition-colors"
              >
                ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// --- PaymentPage ---
function PaymentPage({ amount, onCancel, onConfirm }) {
  const [secondsLeft, setSecondsLeft] = React.useState(600); // 10 ‡∏ô‡∏≤‡∏ó‡∏µ

  React.useEffect(() => {
    if (secondsLeft > 0) {
      const timer = setTimeout(() => setSecondsLeft(secondsLeft - 1), 1000);
      return () => clearTimeout(timer);
    }
  }, [secondsLeft]);

  const formatTime = (sec) => {
    const m = Math.floor(sec / 60).toString().padStart(2, '0');
    const s = (sec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-24 flex flex-col items-center justify-start">
      <Header cartCount={0} showBack={true} onBack={onCancel} />
      <div className="px-5 pt-6 w-full max-w-md">
        <h2 className="text-xl font-bold text-gray-900 mb-4">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
        <div className="bg-white rounded-xl p-4 shadow-sm flex flex-col items-center mb-6">
          <img
            src={`https://promptpay.io/0809614423/${amount}.png`}
            alt="QR Code"
            className="w-52 h-52 object-contain mb-4"
            style={{ background: "#fff", borderRadius: "12px" }}
          />
          <div className="text-red-600 text-lg font-bold mb-2">
            ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {formatTime(secondsLeft)}
          </div>
          <div className="text-gray-800 mb-3 text-center">
            ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ <span className="font-bold text-red-600">{formatCurrency(amount)}</span>
          </div>
          <div className="text-gray-500 text-sm text-center mb-3">
            ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br />
            ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡πÑ‡∏•‡∏ô‡πå
          </div>
        </div>
       <div className="flex space-x-3">
  <button
    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold"
    onClick={onCancel}
  >
    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  </button>
  <button
    className="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold"
    onClick={onConfirm}
  >
    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô
  </button>
  <button
    className="flex-1 bg-yellow-500 text-white py-3 rounded-xl font-bold"
    onClick={() => window.open('https://line.me/R/ti/p/@600ncyqq')}
  >
    ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≤‡∏á LINE
  </button>
</div>
<div className="text-red-500 text-sm mt-2 text-center">
  ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
</div>
      </div>
    </div>
  );
}

// --- PaymentSuccessModal ---
function PaymentSuccessModal({ onClose }) {
  return (
    <div className="modal-overlay">
      <div className="bg-white rounded-2xl p-8 modal-content flex flex-col items-center">
        <i className="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
        <h3 className="font-bold text-xl text-green-600 mb-2">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
        <p className="text-gray-700 mb-4 text-center">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠<br/>‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
        <button
          className="bg-red-500 text-white py-2 px-5 rounded-xl font-bold"
          onClick={onClose}
        >
          ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </button>
        <div className="text-red-500 text-xs mt-3 text-center">
          ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏Å‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡πà‡∏ô‡πÅ‡∏Å‡∏•‡πâ‡∏á ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        </div>
      </div>
    </div>
  );
}

// --- ProfilePage ---
function ProfilePage({ user, setUser, onBack, onShowOrderHistory }) {
  const [edit, setEdit] = React.useState(false);
  const [form, setForm] = React.useState(user);

  const handleSaveProfile = (newData) => {
  if (!newData.name || !newData.phone || !newData.address) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
    return;
  }
  setUser(f => {
    const update = { ...f, ...newData };
    saveUserToStorage(update);
    return update;
  });
  setEdit(false);
};

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-100 via-yellow-50 to-white flex items-center justify-center pb-24">
      <div className="w-full max-w-md mx-auto">
        <Header cartCount={0} showBack={true} onBack={onBack} />
        <div className="flex flex-col items-center mt-6">
          <div className="bg-white rounded-2xl shadow-lg p-8 w-full flex flex-col items-center">
            <div className="mb-5">
              <i className="fas fa-user-circle text-6xl text-orange-300"></i>
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-1">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            {!edit ? (
              <>
                <div className="text-lg font-semibold text-gray-800 mt-2">{user.name || <span className="text-gray-400">‡∏ä‡∏∑‡πà‡∏≠</span>}</div>
                <div className="mt-2 text-sm text-gray-700">
                  <span className="block mb-1"><i className="fas fa-phone-alt mr-2 text-orange-400"></i> {user.phone || <span className="text-gray-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span>}</span>
                  <span className="block mb-1"><i className="fas fa-map-marker-alt mr-2 text-orange-400"></i> {user.address || <span className="text-gray-400">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</span>}</span>
                </div>
                <button className="mt-6 bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-full font-bold shadow transition"
                  onClick={() => setEdit(true)}>
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button className="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow transition"
                  onClick={onShowOrderHistory}>
                  ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
              </>
            ) : (
              <form className="w-full space-y-4 mt-2"
  onSubmit={e => { e.preventDefault(); handleSaveProfile(form); }}>
  <input className="block border px-4 py-3 rounded-full w-full focus:ring-2 focus:ring-orange-200 text-lg"
    placeholder="‡∏ä‡∏∑‡πà‡∏≠"
    value={form.name} onChange={e=>setForm(f=>({...f, name:e.target.value}))}/>
  <input className="block border px-4 py-3 rounded-full w-full focus:ring-2 focus:ring-orange-200 text-lg"
    placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£"
    value={form.phone} onChange={e=>setForm(f=>({...f, phone:e.target.value}))}/>
  <input className="block border px-4 py-3 rounded-full w-full focus:ring-2 focus:ring-orange-200 text-lg"
    placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Google Maps"
    value={form.address} onChange={e=>setForm(f=>({...f, address:e.target.value}))}/>
  <div className="text-xs text-gray-500 mt-1">
    ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps ‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô https://goo.gl/maps/xxxx
  </div>
  <div className="flex gap-3 mt-3">
    <button type="submit" className="bg-green-500 text-white px-6 py-2 rounded-full font-bold flex-1 shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button type="button" className="bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-bold flex-1 shadow"
      onClick={() => setEdit(false)}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</form>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// --- FavoritePage ---
function FavoritePage({ favoriteFoods, onShowFood, onBack }) {
  return (
    <div className="min-h-screen bg-gray-50 pb-24">
      <Header cartCount={0} showBack={true} onBack={onBack}/>
      <div className="px-5 pt-4">
        <h2 className="text-xl font-bold text-gray-900 mb-6">‡πÄ‡∏°‡∏ô‡∏π‡πÇ‡∏õ‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
        {favoriteFoods.length === 0
          ? <div className="text-center text-gray-400 pt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÇ‡∏õ‡∏£‡∏î</div>
          : (
            <div className="grid grid-cols-2 gap-4">
              {favoriteFoods.map(food => (
                <div key={food.id} className="food-card bg-white rounded-2xl shadow-sm overflow-hidden cursor-pointer"
                  onClick={()=>onShowFood(food)}>
                  <img src={food.image} alt={food.name} className="w-full h-28 object-cover"/>
                  <div className="p-3">
                    <div className="font-bold text-gray-900">{food.name}</div>
                    <div className="text-xs text-gray-500">{restaurants.find(r=>r.id===food.restaurantId)?.name}</div>
                    <div className="mt-1">{formatCurrency(food.price)}</div>
                  </div>
                </div>
              ))}
            </div>
          )
        }
      </div>
    </div>
  );
}

// --- OrderHistoryPage ---
function OrderHistoryPage({ orderHistory, onBack }) {
  return (
    <div className="min-h-screen bg-gray-50 pb-24">
      <Header cartCount={0} showBack={true} onBack={onBack}/>
      <div className="px-5 pt-4">
        <h2 className="text-xl font-bold text-gray-900 mb-6">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
        {orderHistory.length === 0
          ? <div className="text-center text-gray-400 pt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
          : (
            <div className="space-y-4">
              {orderHistory.map((order, i) => (
                <div key={i} className="bg-white rounded-xl p-4 shadow">
                  <div className="flex justify-between items-center">
  <span className="font-bold text-gray-800">#{order.orderId}</span>
</div>
                  <div className="text-xs text-gray-700 mb-1">
                    <span>‡∏ä‡∏∑‡πà‡∏≠: {order.userInfo?.name || '-'}</span>
                    <span className="ml-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: {order.userInfo?.phone || '-'}</span>
                  </div>
                  <div className="text-xs text-gray-500 mb-1">
                    {new Date(order.date).toLocaleString("th-TH")}
                  </div>
                  <ul className="text-gray-700 text-sm mb-1 pl-4 list-disc">
                    {order.cart.map((item, j) => (
                      <li key={j}>
                        {item.name} x {item.qty}
                        {/* ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡πà‡∏ô (options) */}
                        {item.selectedOptions && Object.keys(item.selectedOptions).length > 0 && (
                          <ul className="pl-4 text-xs text-gray-500 list-none">
                            {Object.entries(item.selectedOptions).map(([optKey, optVal]) => (
                              <li key={optKey}>{optVal?.name}</li>
                            ))}
                          </ul>
                        )}
                      </li>
                    ))}
                  </ul>
                  <div className="text-xs text-gray-500">‡∏£‡∏ß‡∏° {formatCurrency(order.amount)}</div>
                </div>
              ))}
            </div>
          )
        }
      </div>
    </div>
  );
}

// --- Main App ---
function App() {
  const [page, setPage] = React.useState("home");
  const [selectedCategory, setSelectedCategory] = React.useState("all");
  const [cart, setCart] = React.useState([]);
  const [searchQuery, setSearchQuery] = React.useState("");
  const [filter, setFilter] = React.useState({ restaurant: "", sort: "default", show: false });
  const [selectedItem, setSelectedItem] = React.useState(null);
  const [showOptionsModal, setShowOptionsModal] = React.useState(false);
  const [showPaymentSuccess, setShowPaymentSuccess] = React.useState(false);
  const [user, setUser] = React.useState(loadUserFromStorage());
  const [showFavoritePage, setShowFavoritePage] = React.useState(false);
  const [showOrderHistory, setShowOrderHistory] = React.useState(false);

  // Review Modal
  const [reviewFoodId, setReviewFoodId] = React.useState(null);
  const [reviews, setReviews] = React.useState(initialReviews);

  // Filter logic
  let filteredFoods = foodItems;
  if (selectedCategory !== "all") filteredFoods = filteredFoods.filter(f => f.category === selectedCategory);
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    filteredFoods = filteredFoods.filter(f => f.name.toLowerCase().includes(q) || f.description.toLowerCase().includes(q));
  }
  if (filter.restaurant) filteredFoods = filteredFoods.filter(f => f.restaurantId == filter.restaurant);
  if (filter.sort === "price-asc") filteredFoods = [...filteredFoods].sort((a, b) => a.price - b.price);
  if (filter.sort === "price-desc") filteredFoods = [...filteredFoods].sort((a, b) => b.price - a.price);
  if (filter.sort === "rating-desc") filteredFoods = [...filteredFoods].sort((a, b) => b.rating - a.rating);

  // Add to cart (with options)
  const handleAddToCartClick = (item) => {
    if (item.options && item.options.length > 0) {
      setSelectedItem(item); setShowOptionsModal(true);
    } else {
      addToCart(item, {}, 1);
    }
  };
  const addToCart = (item, selectedOptions = {}, quantity) => {
    setCart(prevCart => {
      let finalPrice = item.price;
      Object.values(selectedOptions).forEach(option => { if (option) finalPrice += option.price; });
      const existingItemIndex = prevCart.findIndex(cartItem =>
        cartItem.id === item.id &&
        JSON.stringify(cartItem.selectedOptions || {}) === JSON.stringify(selectedOptions || {})
      );
      if (existingItemIndex > -1) {
        const updatedCart = [...prevCart];
        updatedCart[existingItemIndex].qty += quantity;
        return updatedCart;
      } else {
        return [...prevCart, {
          ...item,
          qty: quantity,
          price: finalPrice,
          selectedOptions: selectedOptions || {},
          originalPrice: item.price
        }];
      }
    });
  };
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
  const updateQty = (cartItem, newQty) => {
    if (newQty < 1) return;
    setCart(prevCart => prevCart.map(item =>
      item.id === cartItem.id &&
      JSON.stringify(item.selectedOptions||{}) === JSON.stringify(cartItem.selectedOptions||{})
        ? { ...item, qty: newQty }
        : item
    ));
  };
  // ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  const removeItem = (cartItem) => {
    setCart(prevCart => prevCart.filter(item =>
      !(item.id === cartItem.id &&
      JSON.stringify(item.selectedOptions||{}) === JSON.stringify(cartItem.selectedOptions||{}))
    ));
  };

  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î
  const favorites = user.favorites || [];
  const handleToggleFavorite = (foodId) => {
    setUser(u => {
      const update = {
        ...u,
        favorites: favorites.includes(foodId)
          ? favorites.filter(id => id !== foodId)
          : [...favorites, foodId]
      };
      saveUserToStorage(update);
      return update;
    });
  };
  const favoriteFoods = foodItems.filter(f => favorites.includes(f.id));

  // ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
  const foodReviewModalFood = foodItems.find(f => f.id === reviewFoodId);
  const foodReviews = foodReviewModalFood
    ? reviews.filter(r => r.foodId === foodReviewModalFood.id)
    : [];
  const handleAddReview = (newReview) => {
    setReviews(rs => [
      { ...newReview, user: user.name, foodId: foodReviewModalFood.id, createdAt: new Date() },
      ...rs
    ]);
  };

  // ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
  const totalAmount = subtotal + DELIVERY_FEE;

  // Handle order checkout (save to localStorage for admin site)
  const handleOrderCheckout = () => {
    if (!user.name || !user.phone || !user.address) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
      setPage("profile");
      return;
    }
    const orderId = "E" + Math.floor(Math.random() * 1000000);
    const cartWithRestaurantName = cart.map(item => ({
  ...item,
  restaurantName: restaurants.find(r => r.id === item.restaurantId)?.name || ""
}));

const newOrder = {
  orderId,
  userName: user.name,
  userInfo: { name: user.name, phone: user.phone, address: user.address },
  cart: cartWithRestaurantName, // <--- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  amount: totalAmount,
  status: "waiting",
  date: new Date(),
};
    sendOrderToMake(newOrder);
    setUser(u => {
      const newUser = {
        ...u,
        orderHistory: [newOrder, ...(u.orderHistory || [])]
      };
      saveUserToStorage(newUser);
      return newUser;
    });
    setShowPaymentSuccess(true);
    setCart([]);
  };

  // ===== UI =====
  if (showFavoritePage) {
    return <FavoritePage favoriteFoods={favoriteFoods} onShowFood={f=>setReviewFoodId(f.id)} onBack={()=>setShowFavoritePage(false)}/>;
  }
  if (showOrderHistory) {
    return <OrderHistoryPage orderHistory={user.orderHistory || []} onBack={()=>setShowOrderHistory(false)}/>;
  }
  if (page === "profile") {
    return <ProfilePage user={user} setUser={setUser}
      onBack={()=>setPage("home")}
      onShowOrderHistory={()=>{setShowOrderHistory(true);}}/>;
  }
  // ---- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ----
  return (
    <div className="max-w-md mx-auto relative bg-gray-50 min-h-screen">
      <Header
        cartCount={cart.reduce((sum, item) => sum + item.qty, 0)}
        onCartClick={() => setPage("cart")}
        onProfileClick={() => setPage("profile")}
        showBack={false}
      />
      <TabBar
        tabs={[
          { id: "home", name: "‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", icon: <i className="fas fa-store"></i> },
          { id: "fav", name: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î", icon: <i className="fas fa-heart"></i> },
          { id: "order", name: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥", icon: <i className="fas fa-receipt"></i> }
        ]}
        active={page}
        setActive={tab => {
          if (tab === "fav") setShowFavoritePage(true);
          else if (tab === "order") setShowOrderHistory(true);
          else setPage(tab);
        }}
      />
      {page === "home" && (
        <>
        <BannerPromo/>
        <SearchBar
          searchQuery={searchQuery}
          setSearchQuery={setSearchQuery}
          filter={filter}
          setFilter={setFilter}
          enableAdvanced={true}
        />
        <CategoryList
          selectedCategory={selectedCategory}
          onSelectCategory={setSelectedCategory}
        />
        <FoodList
          foods={filteredFoods}
          onAddToCart={handleAddToCartClick}
          searchQuery={searchQuery}
          favorites={favorites}
          onToggleFavorite={handleToggleFavorite}
          onShowReviews={id=>setReviewFoodId(id)}
          reviews={reviews}
        />
        </>
      )}
      {page === "cart" && (
        <CartPage
          cart={cart}
          onUpdateQty={updateQty}
          onRemoveItem={removeItem}
          onBack={() => setPage("home")}
          onCheckout={handleOrderCheckout}
          onPay={() => setPage("payment")}
          totalamount={subtotal}
        />
      )}
      {page === "payment" && (
  <PaymentPage
    amount={subtotal}
    onCancel={() => setPage("cart")}
    onConfirm={handleOrderCheckout}
  />
)}
      {showPaymentSuccess && (
        <PaymentSuccessModal onClose={() => {
          setShowPaymentSuccess(false);
          setPage("home");
        }} />
      )}
      {selectedItem && (
        <ItemOptionsModal
          item={selectedItem}
          isOpen={showOptionsModal}
          onClose={() => setShowOptionsModal(false)}
          onAddToCartWithOptions={addToCart}
        />
      )}
      {reviewFoodId && foodReviewModalFood && (
        <FoodReviewModal
          food={foodReviewModalFood}
          reviews={foodReviews}
          onClose={()=>setReviewFoodId(null)}
          onAddReview={handleAddReview}
          user={user}
        />
      )}
      <footer className="text-center py-6 text-xs text-gray-400">
        &copy; {new Date().getFullYear()} Easy Delivery. All rights reserved.<br />
        <a href="https://lin.ee/" target="_blank" rel="noopener" className="text-red-500 underline">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE</a>
      </footer>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
